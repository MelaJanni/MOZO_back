name: Deploy-Laravel-Simple

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) checkout (obligatorio si luego usÃ¡s cosas del repo local)
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) despliegue por SSH
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1
        with:
          host:      ${{ secrets.SERVER_HOST }}
          username:  ${{ secrets.SERVER_USER }}
          key:       ${{ secrets.SSH_KEY }}
          port:      22
          script: |
            set -e
            echo "ðŸš€  Deploy iniciado"
            echo "ðŸ”Ž  PROJECT_DIR â†’ '/var/www/vhosts/mozoqr.com/httpdocs'"

            # --- 0) borrar clon antiguo ----------------------------------
            if [ -d /var/www/mozo ]; then
              echo "ðŸ§¹  Eliminando /var/www/mozo"
              sudo rm -rf /var/www/mozo
            fi

            # --- 1) asegurar carpeta destino -----------------------------
            PROJECT_DIR="/var/www/vhosts/mozoqr.com/httpdocs"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ðŸ“‚  Creando $PROJECT_DIR"
              mkdir -p "$PROJECT_DIR"
            fi

            git config --global --add safe.directory "$PROJECT_DIR"
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            cd "$PROJECT_DIR"

            # --- 2) clonar / actualizar ----------------------------------
            if [ ! -d .git ]; then
              echo "ðŸ“¥  Clonando repoâ€¦"
              git clone --depth=1 "${{ secrets.REPO_URL }}" .
            else
              echo "ðŸ”„  Haciendo pullâ€¦"
              git fetch origin main
              git reset --hard origin/main
            fi

            # --- 3) dependencias -----------------------------------------
            composer install --no-dev --prefer-dist --optimize-autoloader

            # --- 4) migraciones solo 1Âª vez ------------------------------
            if [ ! -f storage/app/first_deploy_done ]; then
              php artisan migrate:fresh --seed --force
              touch storage/app/first_deploy_done
            fi

            # --- 5) refrescar cachÃ© --------------------------------------
            php artisan config:clear
            php artisan config:cache

            # --- 6) reiniciar serve --------------------------------------
            pkill -f "artisan serve" || true
            nohup php artisan serve --host=0.0.0.0 --port=8000 \
                 > storage/logs/serve.log 2>&1 &

            echo "âœ…  Deploy finalizado en $PROJECT_DIR"
