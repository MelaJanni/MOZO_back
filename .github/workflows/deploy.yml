# ------------------------------------------------------------
#  Deploy Laravel a tu VPS con un workflow ultraligero
# ------------------------------------------------------------
# 1. Se dispara cada push a main.
# 2. Conecta vÃ­a SSH (clave privada en el secret SSH_KEY).
# 3. Si el repo ya existe â†’ git fetch / reset.
#    Si NO existe â†’ elimina todo y clona desde cero.
# 4. Instala dependencias (composer install).
# 5. Solo en el PRIMER deploy corre migraciones + seed.
# 6. Reinicia un servidor php artisan serve (opcional).
# ------------------------------------------------------------

name: Deploy-Laravel-Simple

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Paso vacÃ­o solo para mostrar el inicio en los logs
      - name: ðŸš€  Iniciando deploy
        run: echo "Arrancando pipelineâ€¦"

      - name: ðŸ“¦  Ejecutar script en el VPS
        uses: appleboy/ssh-action@v1
        with:
          host:      ${{ secrets.SERVER_HOST }}
          username:  ${{ secrets.SERVER_USER }}
          key:       ${{ secrets.SSH_KEY }}
          port:      22
          debug:     true

          # Script remoto -----------------------------------------------------------------
          script: |
            set -e                                  # abortar ante el primer error
            echo "ðŸ”  ConexiÃ³n SSH establecida"

            # Aseguramos que Git no se queje de permisos
            git config --global --add safe.directory "${{ secrets.SERVER_PATH }}"

            # Evitamos el warning de github.com al clonar por primera vez
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

            cd "${{ secrets.SERVER_PATH }}"

            echo "ðŸ“‚  Sincronizando cÃ³digoâ€¦"

            # Â¿Ya existe .git?
            if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
              echo "  âžœ Repo encontrado, haciendo fetch + reset"
              git fetch origin main
              git reset --hard origin/main
            else
              echo "  âžœ NO hay repo, clonando desde cero"
              rm -rf ./* ./.??* || true           # borra todo excepto . y ..
              git clone --depth 1 "${{ secrets.REPO_URL }}" .
            fi

            echo "ðŸ“¦  Instalando dependencias Composerâ€¦"
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --ansi

            # Detectar primer deploy con un â€œflag fileâ€
            if [ ! -f storage/app/first_deploy_done ]; then
              echo "ðŸ—„  Primer deploy â†’ migraciones + seed"
              php artisan migrate:fresh --seed --force --no-interaction
              touch storage/app/first_deploy_done
            fi

            echo "ðŸ”„  Limpiando y cacheando configuraciÃ³n"
            php artisan config:clear
            php artisan config:cache

            echo "â™»ï¸  Reiniciando servidor artisan (muy bÃ¡sico)â€¦"
            pkill -f "artisan serve" || true
            nohup php artisan serve --host=0.0.0.0 --port=8000 \
              > storage/logs/serve.log 2>&1 &

            echo "âœ…  Deploy completado con Ã©xito"
