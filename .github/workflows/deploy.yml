# Workflow súper simple para desplegar Laravel a tu VPS
# ------------------------------------------------------
# 1. Se dispara cuando hacés push a main.
# 2. Se conecta por SSH al servidor.
# 3. Hace pull (o clona si es la primera vez).
# 4. Ejecuta composer install.
# 5. Solo en el primer deploy: migrate:fresh --seed.
# 6. Reinicia el servidor con php artisan serve.
# ------------------------------------------------------

name: Deploy-Laravel-Simple

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Run deploy script on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          debug: true
          script: |
            echo "Conexión OK, ahora sí hacemos deploy"
            set -e
            git config --global --add safe.directory ${{ secrets.SERVER_PATH }}
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            cd ${{ secrets.SERVER_PATH }}

            # 1) Traer el código
            if [ ! -d .git ]; then
              git clone --depth=1 git@github.com:${{ github.repository }} .
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            # 2) Dependencias PHP
            composer install --no-dev --prefer-dist --optimize-autoloader

            # 3) Migraciones solo una vez
            if [ ! -f storage/app/first_deploy_done ]; then
              php artisan migrate:fresh --seed --force
              touch storage/app/first_deploy_done
            fi

            # 4) Reiniciar php artisan serve (muy básico)
            pkill -f "artisan serve" || true
            nohup php artisan serve --host=0.0.0.0 --port=8000 > storage/logs/serve.log 2>&1 &
