# üöÄ TODAS LAS APIs DEL SISTEMA MOZO ‚Äî DOCUMENTACI√ìN ACTUALIZADA

√öltima actualizaci√≥n: 2025-09-08

## ‚ö†Ô∏è IMPORTANTE: USO CORRECTO DE APIs

Perfiles separados por rol (sistema actual):
- Usa: `/api/user-profile/waiter/update` (mozo)
- Usa: `/api/user-profile/admin/update` (admin)
- Compleci√≥n: `/api/user-profile/completeness` (preferido) y alias `/api/profile/completeness`

Eliminadas (legacy):
- `/api/profile/update`
- `/api/profile/waiter/update`

Novedades recientes:
- Alias activo para completitud de perfil: `/api/profile/completeness` (compatibilidad FE)
- Nuevos diagn√≥sticos y utilitarios: `/api/health`, `/api/check-user-exists`, `/api/debug/*`
- Nuevas rutas waiter: `calls/{call}/resync`, `businesses/active-today`, `leave-business`, `diagnose`
- Nuevas rutas admin: `business/create`, `businesses` (listar), `business/{id}` (DELETE), `qr/capabilities`, alias de `menus` y `tables`

## üìö √çNDICE
1. [Autenticaci√≥n](#autenticaci√≥n)
2. [Perfiles Separados por Rol (SISTEMA PRINCIPAL)](#perfiles-separados-por-rol-nuevo-sistema)
3. [Funciones Adicionales de Perfil](#funciones-adicionales-de-perfil)
4. [APIs del Mozo - Gesti√≥n de Mesas](#apis-del-mozo---gesti√≥n-de-mesas)
5. [APIs del Admin - Gesti√≥n de Personal](#apis-del-admin---gesti√≥n-de-personal)
6. [APIs del Admin - Panel de Control](#apis-del-admin---panel-de-control)
7. [APIs Generales](#apis-generales)
8. [APIs P√∫blicas (QR)](#apis-p√∫blicas-qr)
9. [Diagn√≥stico y Utilitarios](#diagn√≥stico-y-utilitarios)

---

## üîê AUTENTICACI√ìN

### Registro y Login
```
POST /api/register
Body: {
  "name": "string",
  "email": "string",
  "password": "string",
  "password_confirmation": "string",
  "business_invitation_code": "string" (opcional - crea Staff request autom√°ticamente)
}
Response: { user, access_token, token_type, staff_request_created, business_name, message }

POST /api/login
Body: { "email": "string", "password": "string", "fcm_token": "string" (opcional), "platform": "android|ios|web" (opcional) }
Response: { user, access_token, token_type }

POST /api/login/google
Body: { 
  "google_token": "string", 
  "fcm_token": "string" (opcional),
  "platform": "android|ios|web" (opcional),
  "business_invitation_code": "string" (opcional)
}
Response: { success, user, access_token, token_type, staff_request_created, business_name, message }

POST /api/check-user-exists
Body: { "email": "string" }
Response: { exists: boolean }
Notas: Limitado por throttle (10/min)

POST /api/logout
Headers: Authorization: Bearer {token}
Body: { "token": "string" (opcional - FCM token espec√≠fico) }
Response: { message, deactivated_tables }
```

### Recuperaci√≥n de Contrase√±a
```
POST /api/forgot-password
Body: { "email": "string" }
Response: { message }

POST /api/reset-password
Body: { "token": "string", "email": "string", "password": "string", "password_confirmation": "string" }
Response: { message }

POST /api/change-password
Headers: Authorization: Bearer {token}
Body: { "current_password": "string", "password": "string", "password_confirmation": "string" }
Response: { message }

DELETE /api/delete-account
Headers: Authorization: Bearer {token}
Body: { "password": "string" }
Response: { message }

GET /api/health
Response: { ok, app, env, time, db, db_error? }
```

### Gesti√≥n de Roles
```
GET /api/user
Headers: Authorization: Bearer {token}
Response: { user_data }

POST /api/role/select
Headers: Authorization: Bearer {token}
Body: { "role": "admin|waiter" }
Response: { message, view, token }

Notas de comportamiento:
- Ya no requiere business_id. Solo fija la vista (view) y emite un token con habilidad role:{rol}.
- El FE luego decide qu√© negocio mostrar/seleccionar mediante GETs (p. ej., /api/admin/businesses, /api/waiter/businesses) seg√∫n el rol elegido.
```

### Negocio Activo (gen√©rico)
```
POST /api/business/set-active
Headers: Authorization: Bearer {token}
Body: { "business_id": "integer" }
Response: { success, message, active_business: { id, name, slug?, invitation_code? }, active_business_id }
Notas:
- Valida que el usuario pertenezca al negocio como admin activo o waiter confirmado.
- Aplica para ambos roles.
- Persiste el negocio activo en users.active_business_id (si existe) o en users.business_id (fallback).
- Si sos admin, tambi√©n sincroniza user_active_roles (rol=admin) para que /api/admin/business respete el √∫ltimo negocio seleccionado.
```

---

## üîÑ PERFILES SEPARADOS POR ROL (SISTEMA PRINCIPAL)

### Obtener Perfil Activo
```
GET /api/user-profile/active
Headers: Authorization: Bearer {token}
Query: business_id=number (opcional, usa active_business_id si no se especifica)
Response: {
  "success": true,
  "data": {
    "id": number,
    "type": "admin|waiter",
    "user_id": number,
    "business_id": number,
    "avatar": "string|null",
    "avatar_url": "string",
    "display_name": "string",
    "is_complete": boolean,
    "profile_data": {object} // datos completos del perfil
  }
}
```

### Obtener Todos los Perfiles
```
GET /api/user-profile/all
Headers: Authorization: Bearer {token}
Response: {
  "success": true,
  "data": {
    "waiter_profiles": [
      {
        "id": number,
        "type": "waiter",
        "business_id": number,
        "business_name": "string",
        "avatar_url": "string",
        "display_name": "string",
        "is_complete": boolean,
        "is_active": boolean,
        "is_available": boolean
      }
    ],
    "admin_profiles": [
      {
        "id": number,
        "type": "admin",
        "business_id": number,
        "business_name": "string",
        "avatar_url": "string",
        "display_name": "string",
        "is_complete": boolean,
        "is_primary_admin": boolean,
        "position": "string"
      }
    ],
    "total_profiles": number
  }
}
```

### Actualizar Perfil de Mozo
```
POST /api/user-profile/waiter/update
Headers: Authorization: Bearer {token}
Content-Type: multipart/form-data
Body: {
  "display_name": "string" (opcional),
  "bio": "string" (opcional),
  "phone": "string" (opcional),
  "birth_date": "date" (opcional, formato YYYY-MM-DD),
  "height": "numeric" (opcional, en metros 1.0-2.5),
  "weight": "integer" (opcional, en kg 30-200),
  "gender": "masculino|femenino|otro" (opcional),
  "experience_years": "integer" (opcional, 0-50),
  "employment_type": "employee|freelancer|contractor" (opcional, EN),
  "current_schedule": "morning|afternoon|night|mixed" (opcional, EN),
  "current_location": "string" (opcional),
  "latitude": "numeric" (opcional, -90 a 90),
  "longitude": "numeric" (opcional, -180 a 180),
  "availability_hours": "array" (opcional),
  "skills": "array" (opcional),
  "is_available": "boolean" (opcional),
  "avatar": "file" (opcional, imagen max 2MB)
}
Response: {
  "success": true,
  "message": "Perfil de mozo actualizado exitosamente",
  "data": {
    "id": number,
    "avatar_url": "string",
    "display_name": "string",
    "is_complete": boolean,
    "profile_data": {object}
  }
}

Notas:
- Los campos employment_type y current_schedule deben enviarse en INGL√âS.
- Valores permitidos:
  - employment_type: employee, freelancer, contractor
  - current_schedule: morning, afternoon, night, mixed
- Si se env√≠an valores en espa√±ol, el backend intentar√° mapearlos; si no coinciden con los permitidos, devuelve 422.
```

### Actualizar Perfil de Administrador
```
POST /api/user-profile/admin/update
Headers: Authorization: Bearer {token}
Content-Type: multipart/form-data
Body: {
  "display_name": "string" (opcional),
  "business_name": "string" (opcional),
  "position": "string" (opcional),
  "corporate_email": "string" (opcional),
  "corporate_phone": "string" (opcional),
  "office_extension": "string" (opcional),
  "business_description": "string" (opcional),
  "business_website": "string" (opcional),
  "social_media": "array" (opcional),
  "permissions": "array" (opcional),
  "notify_new_orders": "boolean" (opcional),
  "notify_staff_requests": "boolean" (opcional),
  "notify_reviews": "boolean" (opcional),
  "notify_payments": "boolean" (opcional),
  "avatar": "file" (opcional, imagen max 2MB)
}
Response: {
  "success": true,
  "message": "Perfil de administrador actualizado exitosamente",
  "data": {
    "id": number,
    "avatar_url": "string",
    "display_name": "string",
    "is_complete": boolean,
    "profile_data": {object}
  }
}
```

### Eliminar Avatar del Perfil
```
DELETE /api/user-profile/avatar
Headers: Authorization: Bearer {token}
Body: {} // Sin par√°metros - usa el negocio activo y rol del usuario
Response: {
  "success": true,
  "message": "Avatar eliminado exitosamente",
  "data": {
    "avatar_url": "string" // URL del avatar por defecto
  }
}
```

### Alias de Completitud (Compatibilidad)
```
GET /api/profile/completeness
Headers: Authorization: Bearer {token}
Response: igual que /api/user-profile/completeness
```

### Actualizar cuenta (datos b√°sicos de usuario)
```
PUT /api/account
Headers: Authorization: Bearer {token}
Body: { name?, email?, phone? }
Response: { message, user }
```

---

## üìã FUNCIONES ADICIONALES DE PERFIL

Notas: Rutas legacy de WhatsApp ya no existen.

### Historial Laboral
```
GET /api/profile/work-history
Headers: Authorization: Bearer {token}
Response: { work_experiences_array }

POST /api/profile/work-history
Headers: Authorization: Bearer {token}
Body: {
  "company": "string",
  "position": "string",
  "description": "string" (opcional),
  "start_date": "date",
  "end_date": "date" (opcional)
}
Response: { work_experience }

PUT /api/profile/work-history/{id}
Headers: Authorization: Bearer {token}
Body: { campos a actualizar }
Response: { work_experience }
// DELETE no disponible actualmente
```

### Gesti√≥n de Dispositivos
```
POST /api/device-token
Headers: Authorization: Bearer {token}
Body: { "token": "string", "platform": "string", "expires_at": "datetime" }
Response: { message }

DELETE /api/device-token
Headers: Authorization: Bearer {token}
Body: { "token": "string" (opcional), "id": "integer" (opcional) }
Response: { message }

GET /api/device-tokens/{userId}
Headers: Authorization: Bearer {token}
Response: { device_tokens }
```

---

## üçΩÔ∏è APIS DEL MOZO - GESTI√ìN DE MESAS

### Dashboard y Estado
```
GET /api/waiter/dashboard
Headers: Authorization: Bearer {token}
Response: { dashboard_data }

GET /api/waiter/tables/status
Headers: Authorization: Bearer {token}
Response: { tables_status }
```

### Gesti√≥n de Negocios
```
GET /api/waiter/businesses
Headers: Authorization: Bearer {token}
Response: { businesses }

GET /api/waiter/businesses/active-today
Headers: Authorization: Bearer {token}
Response: { businesses }

GET /api/waiter/businesses/{id}/tables
Headers: Authorization: Bearer {token}
Response: { tables }

POST /api/waiter/join-business
Headers: Authorization: Bearer {token}
Body: { "invitation_code": "string" }
Response: { message, business }

POST /api/waiter/set-active-business
Headers: Authorization: Bearer {token}
Body: { "business_id": "integer" }
Response: { message }

POST /api/waiter/onboard
Headers: Authorization: Bearer {token}
Body: { business_data }
Response: { message, business }

POST /api/waiter/leave-business
Headers: Authorization: Bearer {token}
Response: { message }

GET /api/waiter/diagnose
Headers: Authorization: Bearer {token}
Response: { diagnosis }
```

### Gesti√≥n de Mesas - Individual
```
GET /api/waiter/tables
Headers: Authorization: Bearer {token}
Response: { tables }

GET /api/waiter/tables/assigned
Headers: Authorization: Bearer {token}
Response: { assigned_tables }

GET /api/waiter/tables/available
Headers: Authorization: Bearer {token}
Response: { available_tables }

POST /api/waiter/tables/{table}/activate
Headers: Authorization: Bearer {token}
Response: { message }

DELETE /api/waiter/tables/{table}/activate
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/tables/{table}/silence
Headers: Authorization: Bearer {token}
Response: { message }

DELETE /api/waiter/tables/{table}/silence
Headers: Authorization: Bearer {token}
Response: { message }
```

### Gesti√≥n de Mesas - M√∫ltiples
```
POST /api/waiter/tables/activate/multiple
Headers: Authorization: Bearer {token}
Body: { "table_ids": [1, 2, 3] }
Response: { message, activated_count }

POST /api/waiter/tables/deactivate/multiple
Headers: Authorization: Bearer {token}
Body: { "table_ids": [1, 2, 3] }
Response: { message, deactivated_count }

POST /api/waiter/tables/silence/multiple
Headers: Authorization: Bearer {token}
Body: { "table_ids": [1, 2, 3] }
Response: { message, silenced_count }

POST /api/waiter/tables/unsilence/multiple
Headers: Authorization: Bearer {token}
Body: { "table_ids": [1, 2, 3] }
Response: { message, unsilenced_count }

GET /api/waiter/tables/silenced
Headers: Authorization: Bearer {token}
Response: { silenced_tables }
```

### Gesti√≥n de Llamadas (Real-time con Firebase)
```
GET /api/waiter/calls/pending
Headers: Authorization: Bearer {token}
Response: { pending_calls }

GET /api/waiter/calls/recent
Headers: Authorization: Bearer {token}
Response: { recent_calls }

POST /api/waiter/calls/{call}/acknowledge
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/calls/{call}/complete
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/calls/{call}/resync
Headers: Authorization: Bearer {token}
Response: { message }

GET /api/waiter/calls/history
Headers: Authorization: Bearer {token}
Response: { call_history }
```

### Perfiles de Mesa (Table Profiles)
```
GET /api/waiter/table-profiles
Headers: Authorization: Bearer {token}
Response: { profiles }

POST /api/waiter/table-profiles
Headers: Authorization: Bearer {token}
Body: {
  "name": "string",
  "description": "string" (opcional),
  "table_ids": [1, 2, 3]
}
Response: { message, profile }

GET /api/waiter/table-profiles/{profile}
Headers: Authorization: Bearer {token}
Response: { profile }

PUT /api/waiter/table-profiles/{profile}
Headers: Authorization: Bearer {token}
Body: { campos a actualizar }
Response: { message, profile }

DELETE /api/waiter/table-profiles/{profile}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/table-profiles/{profile}/activate
Headers: Authorization: Bearer {token}
Response: { message, result }

POST /api/waiter/table-profiles/{profile}/deactivate
Headers: Authorization: Bearer {token}
Response: { message }
```

### Notificaciones y FCM
```
GET /api/waiter/notifications
Headers: Authorization: Bearer {token}
Response: { notifications }

POST /api/waiter/notifications/handle/{notificationId}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/notifications/{notificationId}/read
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/notifications/mark-multiple-read
Headers: Authorization: Bearer {token}
Body: { "notification_ids": [1,2,3] }
Response: { message }

POST /api/waiter/notifications/global
Headers: Authorization: Bearer {token}
Body: { notification_data }
Response: { message }

POST /api/waiter/tables/toggle-notifications/{tableId}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/waiter/fcm/register
Headers: Authorization: Bearer {token}
Body: { "token": "string", "platform": "string" }
Response: { message }

POST /api/waiter/fcm/refresh
Headers: Authorization: Bearer {token}
Body: { "old_token": "string", "new_token": "string" }
Response: { message }

GET /api/waiter/fcm/status
Headers: Authorization: Bearer {token}
Response: { token_status }

POST /api/waiter/fcm/test
Headers: Authorization: Bearer {token}
Response: { message }

DELETE /api/waiter/fcm/token
Headers: Authorization: Bearer {token}
Response: { message }
```

### Gesti√≥n de IPs (Anti-spam)
```
POST /api/waiter/ip/block
Headers: Authorization: Bearer {token}
Body: { "ip": "string", "reason": "string" }
Response: { message }

POST /api/waiter/ip/unblock
Headers: Authorization: Bearer {token}
Body: { "ip": "string" }
Response: { message }

GET /api/waiter/ip/blocked
Headers: Authorization: Bearer {token}
Response: { blocked_ips }

GET /api/waiter/ip/debug
Headers: Authorization: Bearer {token}
Response: { ip_debug_info }

POST /api/waiter/ip/force-unblock
Headers: Authorization: Bearer {token}
Body: { "ip": "string" }
Response: { message }
```

---

## üë®‚Äçüíº APIS DEL ADMIN - GESTI√ìN DE PERSONAL

### Ver Personal
```
GET /api/admin/staff
Headers: Authorization: Bearer {token}
Query Params: ?search=nombre&status=confirmed
Response: { 
  staff: [
    {
      id, name, email, phone, status, position, salary, notes, hire_date,
      birth_date, age, height, weight, gender, experience_years,
      user_profile: { datos completos del perfil del mozo },
      associated_businesses: [ { id, name } ]
    }
  ],
  search, total 
}

GET /api/admin/staff/{id}
Headers: Authorization: Bearer {token}
Response: { 
  staff: {
    id, name, email, position, salary, notes, hire_date,
    user_profile: { datos completos del perfil },
    reviews: [ { rating, comment, created_at } ]
  }
}

PUT /api/admin/staff/{id}
Headers: Authorization: Bearer {token}
Body: {
  "name": "string" (opcional),
  "position": "string" (opcional),
  "email": "string" (opcional),
  "phone": "string" (opcional),
  "hire_date": "date" (opcional),
  "salary": "numeric" (opcional),
  "status": "string" (opcional),
  "notes": "string" (opcional)
}
Response: { message, staff }

DELETE /api/admin/staff/{staffId}
Headers: Authorization: Bearer {token}
Response: { message }
```

### Solicitudes de Personal
```
GET /api/admin/staff/requests
Headers: Authorization: Bearer {token}
Response: { 
  requests: [
    {
      id, name, email, status, created_at,
      user_profile: { datos completos del perfil del mozo }
    }
  ],
  count 
}

GET /api/admin/staff/requests/archived
Headers: Authorization: Bearer {token}
Response: { archived_requests, count }

POST /api/admin/staff/request/{requestId}
Headers: Authorization: Bearer {token}
Body: { "action": "confirm|reject|archive|archived" }
Response: { message }

üÜï POST /api/admin/staff/bulk-process
Headers: Authorization: Bearer {token}
Body: { "action": "confirm_all|archive_all" }
Response: { message, processed_count }
```

### Invitar Personal
```
POST /api/admin/staff/invite
Headers: Authorization: Bearer {token}
Body: {
  "name": "string",
  "email": "string",
  "position": "string",
  "phone": "string" (opcional),
  "birth_date": "date" (opcional),
  "height": "numeric" (opcional),
  "weight": "numeric" (opcional),
  "gender": "string" (opcional),
  "experience_years": "integer" (opcional),
  "avatar": "file|string" (opcional)
}
Response: { message, staff }

POST /api/admin/staff/onboard
Headers: Authorization: Bearer {token}
Body: { staff_data }
Response: { message }
```

### Evaluaciones
```
POST /api/admin/staff/{id}/reviews
Headers: Authorization: Bearer {token}
Body: { "rating": 1-5, "comment": "string" (opcional) }
Response: { message, review }

DELETE /api/admin/staff/{staffId}/reviews/{id}
Headers: Authorization: Bearer {token}
Response: { message }
```

## üî• STAFF MANAGEMENT - Sistema de solicitudes de mozos con Firebase

### Gesti√≥n de Solicitudes de Staff
```
GET /api/staff?business_id={id}
Headers: Authorization: Bearer {token}
Response: { 
  success: true,
  data: [
    {
      id, name, email, phone, position, status, 
      experience_years, employment_type, salary, 
      hire_date, created_at, 
      user: { id, name, email } | null
    }
  ]
}

POST /api/staff
Headers: Authorization: Bearer {token}
Body: {
  "business_id": "integer" (required),
  "name": "string" (required),
  "email": "string" (required),
  "phone": "string" (required),
  "position": "string" (required),
  "date_of_birth": "date" (required),
  "height": "number" (required, 1.0-2.5 metros),
  "weight": "number" (required, 30-200 kg),
  "gender": "masculino|femenino|otro" (required),
  "experience_years": "integer" (required, 0-50),
  "employment_type": "tiempo_completo|medio_tiempo|por_horas" (required),
  "current_schedule": "string" (required),
  "user_id": "integer" (opcional),
  "skills": "array" (opcional),
  "latitude": "number" (opcional),
  "longitude": "number" (opcional)
}
Response: { success: true, message: "Solicitud de staff creada exitosamente", data: staff }

GET /api/staff/{id}
Headers: Authorization: Bearer {token}
Response: { 
  success: true,
  data: { 
    id, name, email, phone, position, status, salary, hire_date,
    birth_date, height, weight, gender, experience_years, 
    employment_type, current_schedule, notes, invitation_token,
    invitation_sent_at, created_at, updated_at, user, business
  }
}

POST /api/staff/{id}/approve
Headers: Authorization: Bearer {token}
Body: {
  "salary": "number" (opcional),
  "hire_date": "date" (opcional),
  "notes": "string" (opcional)
}
Response: { success: true, message: "Solicitud de staff aprobada exitosamente", data: staff }

POST /api/staff/{id}/reject
Headers: Authorization: Bearer {token}
Body: { "notes": "string" (opcional) }
Response: { success: true, message: "Solicitud de staff rechazada", data: staff }

POST /api/staff/{id}/invite
Headers: Authorization: Bearer {token}
Response: { 
  success: true, 
  message: "Invitaci√≥n enviada exitosamente",
  data: { 
    invitation_token: "string", 
    invitation_url: "string",
    email_sent: true,
    whatsapp_url: "string"
  }
}

GET /api/staff/{id}/whatsapp
Headers: Authorization: Bearer {token}
Response: {
  success: true,
  data: {
    whatsapp_url: "string",
    phone: "string", 
    invitation_token: "string",
    expires_at: "datetime"
  }
}

DELETE /api/staff/{id}
Headers: Authorization: Bearer {token}
Response: { success: true, message: "Solicitud de staff eliminada exitosamente" }
```

### Unirse con Token de Invitaci√≥n (P√∫blico)
```
POST /api/staff/join/{token}
Body: { "user_id": "integer" (required) }
Response: { success: true, message: "Te has unido al negocio exitosamente", data: staff }
```

### Testing
```
POST /api/staff/test-notifications
Headers: Authorization: Bearer {token}
Body: { "business_id": "integer" (required) }
Response: { success: true, message: "Test de notificaciones de staff completado", data: result }
```

### üÜï Nuevas Funcionalidades Admin
```
GET /api/admin/staff/{id}/whatsapp
Headers: Authorization: Bearer {token}
Response: { whatsapp_url, phone, formatted_phone }

GET /api/admin/profile
Headers: Authorization: Bearer {token}
Response: { 
  profile: {
  id, name, email, avatar_url, phone, position,
    business: { id, name },
    created_at
  }
}

POST /api/admin/profile/update
Headers: Authorization: Bearer {token}
Body: {
  "name": "string" (opcional),
  "email": "string" (opcional),
  "phone": "string" (opcional),
  "avatar": "file" (opcional)
}
Response: { message, profile }
```

---

## ‚öôÔ∏è APIS DEL ADMIN - PANEL DE CONTROL

### Informaci√≥n del Negocio
```
GET /api/admin/business
Headers: Authorization: Bearer {token}
Response: { business, tables_count, menus_count, qr_codes_count, invitation_code, invitation_url }

POST /api/admin/business/create
Headers: Authorization: Bearer {token}
Body: { business_data }
Response: { message, business }

GET /api/admin/businesses
Headers: Authorization: Bearer {token}
Response: { businesses }

DELETE /api/admin/business/{businessId}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/admin/business/regenerate-invitation-code
Headers: Authorization: Bearer {token}
Response: { message, invitation_code, invitation_url }

POST /api/admin/switch-view
Headers: Authorization: Bearer {token}
Body: { "view": "admin|waiter" }
Response: { message, view, token }
```

### Configuraci√≥n
```
GET /api/admin/settings
Headers: Authorization: Bearer {token}
Response: { business, settings }

POST /api/admin/settings
Headers: Authorization: Bearer {token}
Body: { business_settings }
Response: { message, business }

PUT /api/admin/settings
PATCH /api/admin/settings
Headers: Authorization: Bearer {token}
Body: { business_settings }
Response: { message, business }

PUT /api/admin/business/settings (alias)
Headers: Authorization: Bearer {token}
Body: { business_settings }
Response: { message, business }
```

### Gesti√≥n de QR
```
POST /api/admin/qr/generate/{tableId}
Headers: Authorization: Bearer {token}
Response: { qr_code_data }

GET /api/admin/qr/preview/{tableId}
Headers: Authorization: Bearer {token}
Response: { preview_url }

POST /api/admin/qr/export
Headers: Authorization: Bearer {token}
Body: { export_options }
Response: { export_file }

POST /api/admin/qr/email
Headers: Authorization: Bearer {token}
Body: { email_data }
Response: { message }

GET /api/admin/qr/capabilities
Headers: Authorization: Bearer {token}
Response: { capabilities }
```

### Notificaciones
```
POST /api/admin/send-test-notification
Headers: Authorization: Bearer {token}
Body: { "title": "string" (opcional), "body": "string" (opcional) }
Response: { message, users_notified, total_users }

POST /api/admin/send-notification-to-user
Headers: Authorization: Bearer {token}
Body: { "user_id": "integer", "title": "string", "body": "string", "data": {} (opcional) }
Response: { message, sent_to }

GET /api/admin/notifications
Headers: Authorization: Bearer {token}
Response: { notifications }

POST /api/admin/notifications/send-to-all
Headers: Authorization: Bearer {token}
Body: { notification_data }
Response: { message }

POST /api/admin/notifications/send-to-user
Headers: Authorization: Bearer {token}
Body: { notification_data }
Response: { message }

POST /api/admin/notifications/send-to-device
Headers: Authorization: Bearer {token}
Body: { notification_data }
Response: { message }

POST /api/admin/notifications/send-to-topic
Headers: Authorization: Bearer {token}
Body: { notification_data }
Response: { message }

POST /api/admin/notifications/subscribe-to-topic
Headers: Authorization: Bearer {token}
Body: { topic_data }
Response: { message }
```

### Estad√≠sticas
```
GET /api/admin/statistics
Headers: Authorization: Bearer {token}
Response: { 
  tables_count, menus_count, staff_count, 
  pending_requests_count, qr_codes_count, archived_staff_count 
}

GET /api/admin/calls/history
Headers: Authorization: Bearer {token}
Response: { call_history }

GET /api/admin/tables/silenced
Headers: Authorization: Bearer {token}
Response: { silenced_tables }

DELETE /api/admin/tables/{table}/silence
Headers: Authorization: Bearer {token}
Response: { message }

GET /api/admin/tables (alias)
Headers: Authorization: Bearer {token}
Response: { tables }

GET /api/admin/menus (alias)
Headers: Authorization: Bearer {token}
Response: { menus }
```

---

## üè¢ APIS GENERALES

### Gesti√≥n de Mesas
```
GET /api/tables
Headers: Authorization: Bearer {token}
Response: { tables }

POST /api/tables
Headers: Authorization: Bearer {token}
Body: { table_data }
Response: { message, table }

PUT /api/tables/{tableId}
Headers: Authorization: Bearer {token}
Body: { table_data }
Response: { message, table }

DELETE /api/tables/{tableId}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/tables/clone/{tableId}
Headers: Authorization: Bearer {token}
Response: { message, cloned_table }
```

### Gesti√≥n de Men√∫s
```
GET /api/menus
Headers: Authorization: Bearer {token}
Response: { menus }

POST /api/menus
Headers: Authorization: Bearer {token}
Body: { "name": "string", "file": "file", "is_default": "boolean" }
Response: { message, menu }

POST /api/menus/default
Headers: Authorization: Bearer {token}
Body: { "menu_id": "integer" }
Response: { message }

PUT /api/menus/{menu}
Headers: Authorization: Bearer {token}
Body: { "name": "string" }
Response: { message, menu }

DELETE /api/menus/{menu}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/menus/reorder
Headers: Authorization: Bearer {token}
Body: { "menu_ids": [1, 2, 3] }
Response: { message }

GET /api/menus/{menu}/preview
Headers: Authorization: Bearer {token}
Response: { preview_url }

GET /api/menus/{menu}/download
Headers: Authorization: Bearer {token}
Response: { download_file }

GET /api/menus/upload-limits
Headers: Authorization: Bearer {token}
Response: { upload_limits }
```

### Notificaciones de Usuario
```
GET /api/user/notifications
Headers: Authorization: Bearer {token}
Response: { notifications }

POST /api/user/notifications/{id}/read
Headers: Authorization: Bearer {token}
Response: { message }

GET /api/notifications
Headers: Authorization: Bearer {token}
Response: { notifications }

POST /api/notifications/handle/{notificationId}
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/notifications/{notificationId}/read
Headers: Authorization: Bearer {token}
Response: { message }

POST /api/notifications/mark-multiple-read
Headers: Authorization: Bearer {token}
Body: { "notification_ids": [1, 2, 3] }
Response: { message }

POST /api/notifications/global
Headers: Authorization: Bearer {token}
Body: { notification_data }
Response: { message }

POST /api/tables/toggle-notifications/{tableId}
Headers: Authorization: Bearer {token}
Response: { message }
```

---

## üåê APIS P√öBLICAS (QR)

### Informaci√≥n de QR
```
GET /api/qr/{restaurantSlug}/{tableCode}
Response: { table_info, business_info, menu_info }

GET /api/table/{tableId}/status
Response: { table_status, call_status }

GET /api/table/{tableId}/call-status
Response: { success, has_active_call, call }
```

### Llamadas de Mozo (P√∫blico)
```
POST /api/tables/{table}/call-waiter
Body: {
  "restaurant_id": "integer",
  "table_id": "integer",
  "message": "string" (opcional),
  "urgency": "low|normal|high" (opcional)
}
Response: { success, message, data }

GET /api/waiter-notifications/{id}
Response: { notification_status }
```

### Configuraci√≥n Firebase (P√∫blico)
```
GET /api/firebase/config
Response: { firebase_config }

GET /api/firebase/table/{table}/config
Response: { table_firebase_config }

GET /api/firebase/status
Response: { 
  status, real_time_available, fcm_available, 
  frontend_config_available, fallback_polling_enabled,
  config, firebase_write_test, recommendations 
}
```

### Tiempo Real (Server-Sent Events)
```
GET /api/test/sse
Response: SSE stream

GET /api/table/{tableId}/call-status/stream
Response: SSE stream para estado de llamadas

GET /api/notifications/stream
Response: SSE stream para notificaciones

GET /api/notifications/poll
Response: Polling optimizado para notificaciones
```

### Fallback Polling
```
GET /api/waiter/{waiterId}/notifications
Response: { success, data: { pending_calls, recent_calls, total_pending, last_check } }
```

### Testing y Debugging
```
POST /api/test/register-fcm-token
Body: { "token": "string", "platform": "string" }
Response: { message }

POST /api/test-waiter-notification
Body: { test_data }
Response: { success, message, received_data, timestamp }

GET /api/firebase/write-test
Response: { test_write, url, data_sent, firebase_response_status, firebase_response_body, success }

GET /api/firebase/test
Response: { realtime_database_test, type, timestamp }

GET /api/firebase/test-createnotification-method
Response: { test_firebase_write, test_call_id, firebase_url, timestamp }

GET /api/debug/recent-calls
Response: { recent_calls }
```

### Documentaci√≥n
```
GET /api/api-docs
Response: { all_apis_list }
```

---

## üìã NOTAS IMPORTANTES

### Autenticaci√≥n
- Todas las rutas protegidas requieren: `Authorization: Bearer {token}`
- El token se obtiene en `/api/login` o `/api/register`
- Los tokens expiran seg√∫n la configuraci√≥n de Sanctum

### Roles
- `admin`: Acceso completo al negocio
- `waiter`: Acceso a funciones de mozo

### Estados de Staff
- `pending`: Solicitud pendiente de aprobaci√≥n
- `confirmed`: Empleado confirmado y activo
- `invited`: Invitado pero a√∫n no registrado
- `rejected`: Solicitud rechazada
- `archived`: Archivado (diferente a rechazado)

### Campos Editables
**Solo el Mozo puede editar:**
- Datos personales en Profile (foto, bio, tel√©fono, etc.)
- Historial laboral
- Habilidades y disponibilidad

**Solo el Admin puede editar:**
- Cargo (position)
- Salario (salary)  
- Notas (notes)
- Estado del empleado (status)

**Autom√°ticos:**
- Fecha de contrataci√≥n (al confirmar)
- Edad (calculada desde fecha de nacimiento)
- Negocios asociados

### Firebase Real-time
- Las llamadas de mozo usan Firebase para tiempo real
- Fallback a polling si Firebase no est√° disponible
- SSE (Server-Sent Events) como alternativa

### C√≥digos de Invitaci√≥n
- Cada business tiene un c√≥digo √∫nico
- Se usa en registro para crear Staff request autom√°ticamente
- Se puede regenerar desde el panel admin

---

## üîß PARA DESARROLLADORES

### Headers Requeridos
```
Content-Type: application/json
Authorization: Bearer {token}
Accept: application/json
```

### C√≥digos de Estado
- `200`: OK
- `201`: Creado
- `204`: Sin contenido (eliminado)
- `401`: No autorizado
- `403`: Prohibido
- `404`: No encontrado
- `422`: Error de validaci√≥n
- `500`: Error del servidor

### Formato de Errores
```json
{
  "message": "Error message",
  "errors": {
    "field": ["Error specific message"]
  }
}
```

### Paginaci√≥n
Algunas rutas soportan paginaci√≥n con query params:
- `?page=1`
- `?per_page=15`
- `?search=t√©rmino`

---

## üìä ESTRUCTURA DE BASE DE DATOS - NUEVOS PERFILES

### Tabla: waiter_profiles
```sql
- id (primary key)
- user_id (foreign key to users)
- business_id (foreign key to businesses)
- avatar (string, nullable)
- display_name (string, nullable)
- bio (text, nullable)
- phone (string, nullable)
- birth_date (date, nullable)
- height (decimal 3,2, nullable) - en metros
- weight (integer, nullable) - en kg
- gender (enum: masculino|femenino|otro, nullable)
- experience_years (integer, default 0)
- employment_type (enum: por horas|tiempo completo|tiempo parcial|solo fines de semana, nullable)
- current_schedule (enum: ma√±ana|tarde|noche|mixto, nullable)
- current_location (string, nullable)
- latitude (decimal 10,8, nullable)
- longitude (decimal 11,8, nullable)
- availability_hours (json, nullable)
- skills (json, nullable)
- is_active (boolean, default true)
- is_available (boolean, default true)
- rating (decimal 3,2, nullable)
- total_reviews (integer, default 0)
- created_at, updated_at
- unique(user_id, business_id)
```

### Tabla: admin_profiles
```sql
- id (primary key)
- user_id (foreign key to users)
- business_id (foreign key to businesses)
- avatar (string, nullable)
- display_name (string, nullable)
- business_name (string, nullable)
- position (string, default 'Administrador')
- corporate_email (string, nullable)
- corporate_phone (string, nullable)
- office_extension (string, nullable)
- business_description (text, nullable)
- business_website (string, nullable)
- social_media (json, nullable)
- is_primary_admin (boolean, default false)
- permissions (json, nullable)
- last_active_at (timestamp, nullable)
- notify_new_orders (boolean, default true)
- notify_staff_requests (boolean, default true)
- notify_reviews (boolean, default true)
- notify_payments (boolean, default true)
- created_at, updated_at
- unique(user_id, business_id)
```

### Tabla: users (campos agregados)
```sql
- google_id (string, nullable, unique)
- google_avatar (string, nullable)
```

### Relaciones del Modelo User
```php
// Nuevas relaciones
- waiterProfiles() -> hasMany(WaiterProfile)
- adminProfiles() -> hasMany(AdminProfile)
- waiterProfileForBusiness($businessId) -> WaiterProfile|null
- adminProfileForBusiness($businessId) -> AdminProfile|null
- getActiveProfile() -> WaiterProfile|AdminProfile|null
- createOrUpdateProfile($businessId, $data) -> Profile
```

### Caracter√≠sticas del Sistema de Perfiles

**‚ú® Perfiles Separados por Rol:**
- Un usuario puede tener diferentes avatares como mozo vs admin
- Datos espec√≠ficos por rol: ubicaci√≥n para mozos, datos corporativos para admins
- Perfiles independientes por negocio: un usuario puede trabajar en m√∫ltiples negocios

**üîÑ Compatibilidad:**
- Las APIs legacy siguen funcionando (`/api/profile/*`)
- Los usuarios existentes no se ven afectados
- Migraci√≥n gradual al nuevo sistema de perfiles

**üõ°Ô∏è Validaciones:**
- Campos obligatorios diferentes por rol
- Validaci√≥n de archivos de imagen para avatares
- Permisos por rol para actualizar perfiles

**‚ö° Simplificaci√≥n de APIs:**
- Ya no se requiere enviar `business_id` en las actualizaciones
- El sistema usa autom√°ticamente el `active_business_id` del usuario
- Solo se necesita estar autenticado para actualizar el perfil

---

## üîß DIAGN√ìSTICO Y UTILITARIOS

Endpoints √∫tiles para diagn√≥stico (dev/ops):
```
POST /api/debug/upload-test
Headers: Authorization: Bearer {token}
Body: { file: multipart-file }
Response: { success, debug_info }

POST /api/debug/fix-php-limits
Headers: Authorization: Bearer {token}
Response: { success, results, current_limits, recommendations }
```

---

Documentaci√≥n generada autom√°ticamente
*√öltima actualizaci√≥n: 2025-09-08*